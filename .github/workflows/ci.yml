name: CI

on:
  push:
    branches: [ "**" ]
  pull_request:
    branches: [ "**" ]

jobs:
  test:
    name: Lint • Migrate • Test
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest]
        python-version: ["3.10", "3.11"]
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: sheratan
          POSTGRES_PASSWORD: sheratan
          POSTGRES_DB: sheratan
        options: >-
          --health-cmd="pg_isready -U sheratan" 
          --health-interval=10s 
          --health-timeout=5s 
          --health-retries=5
        ports:
          - 5432:5432

    env:
      DATABASE_URL: postgresql+psycopg2://sheratan:sheratan@localhost:5432/sheratan
      HEARTBEAT_INTERVAL: "30"
      LEASE_DURATION: "300"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          if [ -f pyproject.toml ]; then pip install ruff black mypy || true; fi

      - name: Lint (optional)
        run: |
          if command -v ruff >/dev/null 2>&1; then ruff . || true; fi
          if command -v black >/dev/null 2>&1; then black --check . || true; fi
          if command -v mypy >/dev/null 2>&1; then mypy . || true; fi

      - name: Migrate DB (Alembic if present) • Linux
        if: runner.os == 'Linux'
        shell: bash
        run: |
          chmod +x scripts/ci_migrate.sh || true
          ./scripts/ci_migrate.sh || echo "No Alembic found; skipping"

      - name: Migrate DB (Alembic if present) • Windows
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          ./scripts/ci_migrate.ps1

      - name: Run tests
        run: |
          python -m pip install pytest pytest-cov
          if [ -d tests ]; then pytest -q --maxfail=1 --disable-warnings || true; fi

      - name: Show parsed config
        run: |
          python scripts/print_config.py || true